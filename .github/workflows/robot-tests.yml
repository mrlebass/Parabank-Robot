name: Web Regressive E2E

on:
  push:
    branches: ["main"]

  pull_request:
    branches: ["main"]

  workflow_dispatch:
    inputs:
      mode:
        description: "Modo de execução"
        required: true
        default: "parallel"
        type: choice
        options:
          - single
          - parallel
      suite:
        description: "Suite/pasta para rodar no modo single (ex: Resources ou Resources/Transfer)"
        required: true
        default: "Resources"

  # Se quiser agendamento, descomente:
  # schedule:
  #   - cron: "0 3 * * *"

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "robot-pages"
  cancel-in-progress: false

jobs:
  # =========================
  # 1) SINGLE (manual opcional)
  # =========================
  robot-single:
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.mode == 'single' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Google Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/google-linux-keyring.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-linux-keyring.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: Run Robot Tests (headless) - single
        run: |
          mkdir -p Results/single
          TARGET="${{ github.event.inputs.suite || 'Resources' }}"
          robot -d Results/single -v HEADLESS:True "$TARGET"

      - name: Upload artifacts (single)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: robot-results-single
          path: Results/single/**
          retention-days: 14

  # =========================
  # 2) PARALLEL (matrix)
  # =========================
  robot-parallel:
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'parallel' || github.event_name != 'workflow_dispatch' }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - id: login
            suite: Resources/Login
          - id: transfer
            suite: Resources/Transfer
          - id: billpay
            suite: Resources/BillPay
          - id: opennewaccount
            suite: Resources/OpenNewAccount
          - id: updateprofile
            suite: Resources/UpdateProfile

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Google Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/google-linux-keyring.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-linux-keyring.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: Run Robot (headless) - matrix
        run: |
          mkdir -p "Results/${{ matrix.id }}"
          robot -d "Results/${{ matrix.id }}" -v HEADLESS:True "${{ matrix.suite }}"

      - name: Upload artifacts (per suite)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: robot-results-${{ matrix.id }}
          path: Results/${{ matrix.id }}/**
          retention-days: 14

  # =========================
  # 3) PUBLISH TO GITHUB PAGES (sem zip)
  # =========================
  publish-pages:
    needs: [robot-parallel]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Download all robot artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Build public site (index + folders)
        run: |
          mkdir -p public

          # Copia cada artifact para uma pasta em public/
          for d in artifacts/robot-results-*; do
            name=$(basename "$d")                       # ex: robot-results-login
            suite=${name#robot-results-}                # ex: login
            mkdir -p "public/$suite"
            cp -R "$d"/. "public/$suite"/
          done

          # Cria um index.html com links
          cat > public/index.html <<'EOF'
          <!doctype html>
          <html>
          <head>
            <meta charset="utf-8" />
            <title>Robot Framework - Results</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 24px; }
              a { display:block; margin: 8px 0; }
              code { background: #eee; padding: 2px 6px; border-radius: 4px; }
            </style>
          </head>
          <body>
            <h1>Robot Framework - Results</h1>
            <p>Abra os reports por suíte:</p>
            <div id="links"></div>

            <script>
              // Esta lista é preenchida no build via shell (abaixo)
            </script>
          </body>
          </html>
          EOF

          # Injeta links no index
          LINKS=""
          for suite in $(ls -1 public | grep -v index.html); do
            if [ -f "public/$suite/report.html" ]; then
              LINKS="$LINKS<a href='./$suite/report.html'>${suite} - report.html</a>\n"
            fi
            if [ -f "public/$suite/log.html" ]; then
              LINKS="$LINKS<a href='./$suite/log.html'>${suite} - log.html</a>\n"
            fi
          done

          # Coloca links dentro do index.html (antes do </div>)
          perl -0777 -i -pe "s#<div id=\"links\"></div>#<div id=\"links\">$LINKS</div>#s" public/index.html

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
